name: Deploy to GitHub Pages

on:
  push:
    branches: [ main ]
  workflow_dispatch:

# Sets permissions of the GITHUB_TOKEN to allow deployment to GitHub Pages
permissions:
  contents: read
  pages: write
  id-token: write

# Allow only one concurrent deployment, skipping runs queued between the run in-progress and latest queued.
# However, do NOT cancel in-progress runs as we want to allow these production deployments to complete.
concurrency:
  group: "pages"
  cancel-in-progress: false

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Set up Python 3.11
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
    
    - name: Install uv
      uses: astral-sh/setup-uv@v3
      with:
        enable-cache: true
    
    - name: Install dependencies
      run: |
        uv sync
    
    - name: Start Flask server in background
      run: |
        uv run python app.py &
        SERVER_PID=$!
        echo $SERVER_PID > server.pid
        echo "Server PID: $SERVER_PID"
        
        # Wait for server to start (max 30 seconds)
        echo "Waiting for server to start..."
        for i in {1..30}; do
          if curl -s http://localhost:8765/api/check-adb > /dev/null 2>&1; then
            echo "Server is ready!"
            break
          fi
          echo "Attempt $i/30..."
          sleep 1
        done
        
        # Verify server is running
        if ! curl -f http://localhost:8765/api/check-adb; then
          echo "Server failed to start"
          exit 1
        fi
    
    - name: Create static site directory
      run: |
        mkdir -p _site
    
    - name: Capture main page from running server
      run: |
        echo "Capturing index.html from running Flask server..."
        curl -o _site/index.html http://localhost:8765/
        
        # Verify the file was created and has content
        if [ ! -s _site/index.html ]; then
          echo "Failed to capture index.html"
          exit 1
        fi
        echo "Successfully captured index.html ($(wc -c < _site/index.html) bytes)"
    
    - name: Copy static assets (CSS, JS)
      run: |
        echo "Copying static assets..."
        cp -r static/css _site/
        cp -r static/js _site/
        
        # Copy any images if they exist
        if [ -d "static/images" ]; then
          cp -r static/images _site/
        fi
        
        echo "Static assets copied successfully"
    
    - name: Add static site notice
      run: |
        # Create a notice banner for the static site
        cat > _site/static-notice.js << 'EOF'
        // This is a static version of adb-turbo deployed to GitHub Pages
        // To use the full functionality, please run the server locally
        (function() {
          // Wait for DOM to be ready
          if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', addNotice);
          } else {
            addNotice();
          }
          
          function addNotice() {
            const notice = document.createElement('div');
            notice.style.cssText = 'position: fixed; top: 0; left: 0; right: 0; background: #fbbf24; color: #78350f; padding: 1rem; text-align: center; z-index: 9999; font-weight: bold; box-shadow: 0 2px 4px rgba(0,0,0,0.1);';
            notice.innerHTML = 'ðŸ“– This is a static preview of adb-turbo. To use it with your Android devices, <a href="https://github.com/kibotu/adb-turbo" style="color: #78350f; text-decoration: underline; font-weight: bold;">run it locally</a>.';
            document.body.insertBefore(notice, document.body.firstChild);
            
            // Adjust body padding to account for fixed notice
            document.body.style.paddingTop = notice.offsetHeight + 'px';
          }
        })();
        EOF
        
        # Inject the notice script into index.html before closing body tag
        sed -i 's|</body>|<script src="/static-notice.js"></script>\n</body>|' _site/index.html
        
        echo "Static notice added to index.html"
    
    - name: Stop Flask server
      if: always()
      run: |
        echo "Stopping Flask server..."
        if [ -f server.pid ]; then
          kill $(cat server.pid) 2>/dev/null || true
          rm server.pid
          echo "Server stopped"
        fi
    
    - name: Verify build output
      run: |
        echo "Build output structure:"
        ls -lah _site/
        echo ""
        echo "CSS files:"
        ls -lah _site/css/ || echo "No CSS directory"
        echo ""
        echo "JS files:"
        ls -lah _site/js/ || echo "No JS directory"
        echo ""
        echo "index.html size: $(wc -c < _site/index.html) bytes"
    
    - name: Upload artifact
      uses: actions/upload-pages-artifact@v3
      with:
        path: '_site'

  deploy:
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    runs-on: ubuntu-latest
    needs: build
    steps:
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
