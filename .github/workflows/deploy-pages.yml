name: Deploy to GitHub Pages

on:
  push:
    branches: [ main ]
  workflow_dispatch:

# Sets permissions of the GITHUB_TOKEN to allow deployment to GitHub Pages
permissions:
  contents: write  # Changed from 'read' to 'write' to allow pushing to gh-pages branch
  pages: write
  id-token: write

# Allow only one concurrent deployment, skipping runs queued between the run in-progress and latest queued.
# However, do NOT cancel in-progress runs as we want to allow these production deployments to complete.
concurrency:
  group: "pages"
  cancel-in-progress: false

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0  # Fetch all history for all branches
    
    - name: Set up Python 3.11
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
    
    - name: Install uv
      uses: astral-sh/setup-uv@v3
      with:
        enable-cache: true
    
    - name: Install dependencies
      run: |
        uv sync
    
    - name: Start Flask server in background
      run: |
        # Start the Flask server in the background
        uv run python app.py &
        SERVER_PID=$!
        echo "SERVER_PID=$SERVER_PID" >> $GITHUB_ENV
        echo "Flask server started with PID: $SERVER_PID"
    
    - name: Build static site
      run: |
        # Run the static site generator
        uv run python build_static.py
    
    - name: Stop Flask server
      if: always()
      run: |
        if [ ! -z "$SERVER_PID" ]; then
          kill $SERVER_PID || true
        fi
        # Also kill any remaining Python processes
        pkill -f "python.*app.py" || true
    
    - name: Deploy to GitHub Pages
      run: |
        # Move build directory outside the repo to preserve it
        mv build /tmp/gh-pages-build
        
        # Configure git
        git config --global user.name "github-actions[bot]"
        git config --global user.email "github-actions[bot]@users.noreply.github.com"
        
        # Check if gh-pages branch exists
        if git ls-remote --exit-code --heads origin gh-pages; then
          echo "gh-pages branch exists, checking it out..."
          git fetch origin gh-pages
          git checkout gh-pages
          # Remove all files except .git
          git rm -rf .
          git clean -fxd
        else
          echo "gh-pages branch does not exist, creating it..."
          git checkout --orphan gh-pages
          git rm -rf .
        fi
        
        # Copy build files from temp location to root
        cp -r /tmp/gh-pages-build/* .
        cp /tmp/gh-pages-build/.nojekyll .
        
        # Add all files
        git add -A
        
        # Check if there are changes to commit
        if git diff --staged --quiet; then
          echo "No changes to deploy"
        else
          echo "Committing and pushing changes..."
          git commit -m "Deploy to GitHub Pages - $(date +'%Y-%m-%d %H:%M:%S')"
          git push origin gh-pages --force
        fi
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

